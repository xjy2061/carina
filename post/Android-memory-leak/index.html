<!DOCTYPE html>
<html lang="en-us">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Android memory leak -- Carina</title>

    

    
    <link href="https://xjy2061.github.io/carina//css/bootstrap.min.css" rel="stylesheet">

    
    <link href="https://xjy2061.github.io/carina//css/clean-blog.min.css" rel="stylesheet">

    
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>

    
    
    
	
	<link href="https://xjy2061.github.io/carina//css/prism.css" rel="stylesheet" />

</head>

<body>

    
    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        <div class="container-fluid">
            
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="https://xjy2061.github.io/carina/">Carina</a>
            </div>

                       
            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav navbar-right">
                    
                    <li>
                        <a href="/carina/">home</a>
                    </li>
                    
                    <li>
                        <a href="/carina/note/">Notes</a>
                    </li>
                    
                  </ul>
            </div>
           

        </div>
        
    </nav>


    
    
    <header class="intro-header" style="background-image: url('https://xjy2061.github.io/carina//img/post-bg.jpg')">
    
      <div class="container">
        <div class="row">
           <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
             <div class="post-heading">
               <h1>Android memory leak</h1>
               <h2 class="subheading"></h2>
               <span class="meta">
                 
Posted by <a href="#">xjy2061</a> on Sun, Sep 10, 2017
<br />
In <a href="/categories/post">Post</a>

<br />
Tags <a href="/tags/android">android</a>, <a href="/tags/memory-leak">memory leak</a>

               </span>
             </div>
           </div>
        </div>
      </div>
    </header>

    
    <article>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  

<h2 id="leak-because-of-system-bug">Leak because of system bug</h2>

<h3 id="phonestatelistener-leak"><code>PhoneStateListener</code> leak</h3>

<p>Below 7.0 a non static inner class <code>IPhoneStateListener.Stub</code> callback in <code>PhoneStateListener</code> references to outside <code>PhoneStateListener</code>, even caller has been destroyed and &ldquo;un-registered&rdquo; the <code>PhoneStateListener</code>, the references coming from: Native Stack &ndash;&gt; PhoneStateListener &ndash;&gt; Context(Activity).</p>

<p>A wrapper class wraps a weak reference of <code>PhoneStateListener</code> can be used to avoid this memory leak.</p>

<blockquote>
<p>Caution: The original <code>PhoneStateListener</code> object must be referenced by caller class, otherwise the weak reference in the wrapper class will get <code>null</code>.</p>
</blockquote>

<pre><code class="language-java">public class PhoneStateListenerWrapper extends PhoneStateListener {
    private WeakReference&lt;PhoneStateListener&gt; mPhoneStateListenerRef;

    public PhoneStateListenerWrapper(PhoneStateListener phoneStateListener) {
        mPhoneStateListenerRef = new WeakReference&lt;&gt;(phoneStateListener);
    }

    @Override
    public void onCallStateChanged(int state, String incomingNumber) {
        super.onCallStateChanged(state, incomingNumber);
        PhoneStateListener phoneStateListener = mPhoneStateListenerRef.get();
        if (phoneStateListener != null) {
            phoneStateListener.onCallStateChanged(state, incomingNumber);
        }
    }
}

private PhoneStateListener mPhoneStateListener = new PhoneStateListener() {
    @Override
    public void onCallStateChanged(int state, String incomingNumber) {
        super.onCallStateChanged(state, incomingNumber);
        //...
    }
};
private PhoneStateListenerWrapper mPhoneStateListenerWrapper = new PhoneStateListenerWrapper(mPhoneStateListener);

((TelephonyManager) mContext.getSystemService(Context.TELEPHONY_SERVICE)).listen(mPhoneStateListenerWrapper, PhoneStateListener.LISTEN_CALL_STATE);
((TelephonyManager) mContext.getSystemService(Context.TELEPHONY_SERVICE)).listen(mPhoneStateListenerWrapper, PhoneStateListener.LISTEN_NONE);
</code></pre>

<h3 id="audiomanager-leak"><code>AudioManager</code> leak</h3>

<p>Below 6.0 <code>AudioManager</code> reference to the incoming context of constructor directly, the related issue is <a href="https://issuetracker.google.com/issues/37024105">here</a>.</p>

<p>A simple workaround is using <code>Application</code> context to get <code>AudioManager</code>.</p>

<pre><code class="language-java">mAudioManager = (AudioManager) context.getApplicationContext().getSystemService(Context.AUDIO_SERVICE);
</code></pre>

<h3 id="inputmethodmanager-leak"><code>InputMethodManager</code> leak</h3>

<p>Refer to <a href="https://issuetracker.google.com/issues/37043700">issue 37043700</a> and <a href="https://issuetracker.google.com/issues/37090736">issue 37090736</a>, <code>mCurRootView</code> or <code>mServedView</code> or <code>mNextServedView</code> in <code>InputMethodManager</code> may reference to last focused view in a wide system version range. But I have not found this kind of leak in official system. However, <code>mLastSrvView</code> of <code>InputMethodManager</code> may cause leak in huawei 6.0 device, and <code>mLastSrvView</code> field is not found in official source code, I think this is a leak for certain manufacturer.</p>

<p>To fix this kind of leak, a straight way is set the relative field of <code>InputMethodManager</code> to <code>null</code> when activity destroyed. Considering there may be multiple activities have this leak, a better way is fix this leak in the <code>onActivityDestroyed(Activity activity)</code> method of <code>ActivityLifecycleCallbacks</code>.</p>

<pre><code class="language-java">@Override
public void onActivityDestroyed(Activity activity) {
	MemoryLeakFixer.fixInputMethodManagerLeak(activity);
}

public class MemoryLeakFixer {

    public static void fixInputMethodManagerLeak(Activity activity) {
        //Surround with a appropriate if condition to make sure execute fix when leak real exists is better.
        InputMethodManager inputMethodManager = null;
        try {
            inputMethodManager = (InputMethodManager) activity.getApplicationContext().getSystemService(Context.INPUT_METHOD_SERVICE);
        } catch (Throwable t) {
            t.printStackTrace();
        }
        if (inputMethodManager!= null) {
            String[] fieldNames = new String[]{&quot;mCurRootView&quot;, &quot;mServedView&quot;, &quot;mNextServedView&quot;, &quot;mLastSrvView&quot;/*huawei*/};
            Class clazz = inputMethodManager.getClass();
            for (String fieldName : fieldNames) {
                try {
                    Field field = clazz.getDeclaredField(fieldName);
                    if (field != null) {
                        if (!field.isAccessible()) {
                            field.setAccessible(true);
                        }
                        Object obj = field.get(inputMethodManager);
                        if (obj instanceof View) {
                            View view = (View) obj;
                            if (view.getContext() == activity) {
                                field.set(inputMethodManager, null);
                            }
                        }
                    }
                } catch (Throwable t) {
                    t.printStackTrace();
                }
            }
        }
    }
}
</code></pre>

<h3 id="textline-leak"><code>TextLine</code> leak</h3>

<p>An activity context may be referenced by <code>sCached</code> in <code>TextLine</code>, a simple solution is set every element of <code>sCached</code> to <code>null</code> in activity&rsquo;s <code>onDestroy</code> method.</p>

<pre><code class="language-java">public static void fixTextLineLeak() {
    try {
        Field field = Class.forName(&quot;android.text.TextLine&quot;).getDeclaredField(&quot;sCached&quot;);
        field.setAccessible(true);
        Object[] sCached = (Object[]) field.get(null);
        if (sCached != null) {
            for (int i = 0; i &lt; sCached.length; i++) {
                sCached[i] = null;
            }
        }
    } catch (Throwable t) {
        t.printStackTrace();
    }
}
</code></pre>

<h2 id="leak-because-of-misuse">Leak because of misuse</h2>

<h3 id="unremoved-viewtreeobserver-listener-leak">Unremoved <code>ViewTreeObserver</code> listener leak</h3>

<p>The scenario is after create a new item view for a <code>ViewPager</code> by the <code>instantiateItem</code> method of <code>PageAdapter</code>, a listener reference to the item view indirectly have been add to the <code>ViewTreeObserver</code> of the item view, and the listener never be removed from the <code>ViewTreeObserver</code>, cause the item view leak even the view has been removed from the view hierarchy in the <code>destroyItem</code> method of <code>PageAdapter</code>.</p>

<p><strong>Never forgot remove listeners of <code>ViewTreeObserver</code>.</strong></p>

<pre><code class="language-java">final ViewTreeObserver observer = view.getViewTreeObserver();
if (observer != null) {
	observer.addOnGlobalLayoutListener(new ViewTreeObserver.OnGlobalLayoutListener() {
	    @Override
	    public void onGlobalLayout() {
    	    //do something
			if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) {
				observer.removeOnGlobalLayoutListener(this);
			} else {
				observer.removeGlobalOnLayoutListener(this);
			}
		}
	});
}
</code></pre>

                  

                </div>
            </div>
        </div>
    </article>

    <hr>
    
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                  <ul class="list-inline text-center">
                    
                      <li>
                        <a href="mailto:xjy2061@gmail.com">
                          <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-envelope-o fa-stack-1x fa-inverse"></i>
                          </span>
                        </a>
                      </li>
                    
                    
                    <li>
                      <a href="https://github.com/xjy2061">
                        <span class="fa-stack fa-lg">
                          <i class="fa fa-circle fa-stack-2x"></i>
                          <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                      </a>
                    </li>
                    
                  </ul>
                  <p class="copyright text-muted"></p>
                </div>
            </div>
        </div>
    </footer>

    
    <script src="https://xjy2061.github.io/carina//js/jquery.min.js"></script>

    
    <script src="https://xjy2061.github.io/carina//js/bootstrap.min.js"></script>

    
    <script src="https://xjy2061.github.io/carina//js/clean-blog.js"></script>

    
	
	<script src="https://xjy2061.github.io/carina//js/prism.js"></script>

</body>

</html>

